<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary: #1db954;
            --dark: #121212;
            --light: #ffffff;
            --secondary: #282828;
            --text-grey: #b3b3b3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
        }
        
        body {
            background-color: var(--dark);
            color: var(--light);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--secondary);
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 28px;
            font-weight: 700;
        }
        
        .logo {
            color: var(--primary);
            margin-right: 10px;
        }
        
        /* Search bar styles */
        .search-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex-grow: 1;
            min-width: 200px;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary);
            color: var(--light);
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: 2px solid var(--primary);
        }
        
        .filter-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .filter-button {
            background-color: var(--secondary);
            color: var(--text-grey);
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .filter-button.active {
            background-color: var(--primary);
            color: white;
        }
        
        .filter-button:hover {
            background-color: #333;
        }
        
        .search-results-count {
            color: var(--text-grey);
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .playlist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 100px;
        }
        
        .track-card {
            background-color: var(--secondary);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .track-card:hover {
            background-color: #333;
            transform: translateY(-5px);
        }
        
        .track-card.active {
            box-shadow: 0 0 0 2px var(--primary);
        }
        
        .track-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background-color: #444;
            position: relative;
            overflow: hidden;
        }
        
        .track-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .track-card:hover .play-overlay {
            opacity: 1;
        }
        
        .play-overlay i {
            font-size: 40px;
            color: var(--light);
        }
        
        .track-info {
            padding: 15px;
        }
        
        .track-title {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-artist {
            font-size: 14px;
            color: var(--text-grey);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--secondary);
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            z-index: 100;
        }
        
        .player-track-info {
            display: flex;
            align-items: center;
            width: 30%;
        }
        
        .player-track-image {
            width: 56px;
            height: 56px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #444;
            overflow: hidden;
        }
        
        .player-track-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-track-details {
            overflow: hidden;
        }
        
        .player-track-title {
            font-weight: 500;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-track-artist {
            font-size: 12px;
            color: var(--text-grey);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-controls {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .player-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .player-button {
            background: none;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 16px;
            margin: 0 15px;
        }
        
        .player-button.main {
            font-size: 32px;
            color: var(--primary);
        }
        
        .player-button:hover {
            color: var(--primary);
        }
        
        .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
        }
        
        .progress-time {
            font-size: 12px;
            color: var(--text-grey);
            min-width: 40px;
        }
        
        .progress-bar {
            flex-grow: 1;
            height: 4px;
            background-color: #5e5e5e;
            border-radius: 2px;
            margin: 0 10px;
            cursor: pointer;
            position: relative;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary);
            border-radius: 2px;
            width: 0;
        }
        
        .player-options {
            width: 30%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
        }
        
        .volume-icon {
            color: var(--text-grey);
            margin-right: 10px;
        }
        
        .volume-slider {
            width: 100px;
            height: 4px;
            background-color: #5e5e5e;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .volume-level {
            height: 100%;
            background-color: var(--primary);
            border-radius: 2px;
            width: 70%;
        }
        
        @media (max-width: 768px) {
            .playlist {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .player {
                flex-direction: column;
                padding: 10px;
            }
            
            .player-track-info, .player-controls, .player-options {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .player-options {
                justify-content: center;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .filter-buttons {
                justify-content: center;
            }
        }

        .no-music-message {
            text-align: center;
            color: var(--text-grey);
            padding: 40px 0;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            color: var(--text-grey);
            padding: 40px 0;
            font-size: 18px;
        }
        
        .load-more-container {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
        }
        
        .load-more {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .load-more:hover {
            background-color: #1ed760;
        }

        /* Modal styles for video player */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .video-modal-content {
            position: relative;
            width: 80%;
            max-width: 900px;
            background-color: transparent;
        }

        .video-player {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
        }

        .video-player video {
            width: 100%;
            display: block;
        }

        .close-video {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close-video:hover {
            color: var(--primary);
        }

        /* Video player controls */
        .video-controls {
            background-color: var(--secondary);
            padding: 15px 20px;
            display: flex;
            align-items: center;
        }

        .video-track-info {
            display: flex;
            align-items: center;
            width: 30%;
        }

        .video-track-image {
            width: 56px;
            height: 56px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: #444;
            overflow: hidden;
        }

        .video-track-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-track-details {
            overflow: hidden;
        }

        .video-track-title {
            font-weight: 500;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-track-artist {
            font-size: 12px;
            color: var(--text-grey);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-main-controls {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .video-button {
            background: none;
            border: none;
            color: var(--light);
            cursor: pointer;
            font-size: 16px;
            margin: 0 15px;
        }

        .video-button.main {
            font-size: 32px;
            color: var(--primary);
        }

        .video-button:hover {
            color: var(--primary);
        }

        .video-progress-container {
            width: 100%;
            display: flex;
            align-items: center;
        }

        .video-progress-time {
            font-size: 12px;
            color: var(--text-grey);
            min-width: 40px;
        }

        .video-progress-bar {
            flex-grow: 1;
            height: 4px;
            background-color: #5e5e5e;
            border-radius: 2px;
            margin: 0 10px;
            cursor: pointer;
            position: relative;
        }

        .video-progress {
            height: 100%;
            background-color: var(--primary);
            border-radius: 2px;
            width: 0;
        }

        .video-options {
            width: 30%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .video-volume-container {
            display: flex;
            align-items: center;
        }

        .video-volume-icon {
            color: var(--text-grey);
            margin-right: 10px;
        }

        .video-volume-slider {
            width: 100px;
            height: 4px;
            background-color: #5e5e5e;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .video-volume-level {
            height: 100%;
            background-color: var(--primary);
            border-radius: 2px;
            width: 70%;
        }

        @media (max-width: 768px) {
            .video-modal-content {
                width: 95%;
            }

            .video-controls {
                flex-direction: column;
                padding: 10px;
            }
            
            .video-track-info, .video-main-controls, .video-options {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .video-options {
                justify-content: center;
            }
        }

        .add-track {
            color: #FFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-headphones logo"></i> Files</h1>
            <div align="right"><a href="add_music.php" class="add-track">Add track</a></div>
        </header>
        
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Search tracks...">
            <div class="filter-buttons">
                <button class="filter-button active" data-filter="all">All</button>
                <button class="filter-button" data-filter="mp3">MP3</button>
                <button class="filter-button" data-filter="mp4">MP4</button>
                <button class="filter-button" data-filter="jpg">JPG</button>
            </div>
        </div>
        <div class="search-results-count" id="results-count"></div>
        
        <div class="playlist">
            <div class="loading">
                <p>Loading music tracks...</p>
            </div>
        </div>
    </div>

    <div class="player">
        <div class="player-track-info">
            <div class="player-track-image">
                <img id="current-thumbnail" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/svgs/solid/music.svg" alt="Current track">
            </div>
            <div class="player-track-details">
                <div id="current-title" class="player-track-title">Select a track</div>
                <div id="current-artist" class="player-track-artist">to start playing</div>
            </div>
        </div>
        <div class="player-controls">
            <div class="player-buttons">
                <button id="prev-button" class="player-button"><i class="fas fa-step-backward"></i></button>
                <button id="play-button" class="player-button main"><i class="fas fa-play"></i></button>
                <button id="next-button" class="player-button"><i class="fas fa-step-forward"></i></button>
            </div>
            <div class="progress-container">
                <div id="current-time" class="progress-time">0:00</div>
                <div id="progress-bar" class="progress-bar">
                    <div id="progress" class="progress"></div>
                </div>
                <div id="duration" class="progress-time">0:00</div>
            </div>
        </div>
        <div class="player-options">
            <div class="volume-container">
                <div class="volume-icon">
                    <i class="fas fa-volume-up"></i>
                </div>
                <div id="volume-slider" class="volume-slider">
                    <div id="volume-level" class="volume-level"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="video-modal">
        <div class="video-modal-content">
            <button class="close-video" id="close-video"><i class="fas fa-times"></i></button>
            <div class="video-player">
                <video id="video-player"></video>
                <div class="video-controls">
                    <div class="video-track-info">
                        <div class="video-track-image">
                            <img id="video-thumbnail" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/svgs/solid/music.svg" alt="Current video">
                        </div>
                        <div class="video-track-details">
                            <div id="video-title" class="video-track-title">Video Title</div>
                            <div id="video-artist" class="video-track-artist">Video Artist</div>
                        </div>
                    </div>
                    <div class="video-main-controls">
                        <div class="video-buttons">
                            <button id="video-prev-button" class="video-button"><i class="fas fa-step-backward"></i></button>
                            <button id="video-play-button" class="video-button main"><i class="fas fa-play"></i></button>
                            <button id="video-next-button" class="video-button"><i class="fas fa-step-forward"></i></button>
                        </div>
                        <div class="video-progress-container">
                            <div id="video-current-time" class="video-progress-time">0:00</div>
                            <div id="video-progress-bar" class="video-progress-bar">
                                <div id="video-progress" class="video-progress"></div>
                            </div>
                            <div id="video-duration" class="video-progress-time">0:00</div>
                        </div>
                    </div>
                    <div class="video-options">
                        <div class="video-volume-container">
                            <div class="video-volume-icon">
                                <i class="fas fa-volume-up"></i>
                            </div>
                            <div id="video-volume-slider" class="video-volume-slider">
                                <div id="video-volume-level" class="video-volume-level"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const audioPlayer = document.getElementById('audio-player');
            const playButton = document.getElementById('play-button');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTime = document.getElementById('current-time');
            const duration = document.getElementById('duration');
            const currentThumbnail = document.getElementById('current-thumbnail');
            const currentTitle = document.getElementById('current-title');
            const currentArtist = document.getElementById('current-artist');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeLevel = document.getElementById('volume-level');
            const playlistContainer = document.querySelector('.playlist');
            
            // Video player elements
            const videoModal = document.getElementById('video-modal');
            const videoPlayer = document.getElementById('video-player');
            const closeVideo = document.getElementById('close-video');
            const videoPlayButton = document.getElementById('video-play-button');
            const videoPrevButton = document.getElementById('video-prev-button');
            const videoNextButton = document.getElementById('video-next-button');
            const videoProgressBar = document.getElementById('video-progress-bar');
            const videoProgress = document.getElementById('video-progress');
            const videoCurrentTime = document.getElementById('video-current-time');
            const videoDuration = document.getElementById('video-duration');
            const videoThumbnail = document.getElementById('video-thumbnail');
            const videoTitle = document.getElementById('video-title');
            const videoArtist = document.getElementById('video-artist');
            const videoVolumeSlider = document.getElementById('video-volume-slider');
            const videoVolumeLevel = document.getElementById('video-volume-level');
            
            // Search elements
            const searchInput = document.getElementById('search-input');
            const filterButtons = document.querySelectorAll('.filter-button');
            const resultsCount = document.getElementById('results-count');
            
            let isPlaying = false;
            let isVideoPlaying = false;
            let currentTrackIndex = 0;
            let currentVideoIndex = 0;
            let tracks = [];
            let currentJsonIndex = 1;
            let isLoading = false;
            let currentFilter = 'all';
            let currentSearchQuery = '';
            
            // Function to check file extension
            function getFileExtension(filePath) {
                return filePath.split('.').pop().toLowerCase();
            }
            
            // Function to handle track click
            function handleTrackClick(index) {
                const track = tracks[index];
                if (!track) return;
                
                const extension = getFileExtension(track.filePath);
                
                if (extension === 'mp3') {
                    // For MP3 files, play as usual
                    currentTrackIndex = index;
                    loadTrack(currentTrackIndex);
                    playTrack();
                } else if (extension === 'mp4') {
                    // For MP4 files, show in modal
                    currentVideoIndex = index;
                    loadVideoTrack(currentVideoIndex);
                    playVideoTrack();
                    videoModal.style.display = 'flex';
                } else {
                    // For other files, open in new tab
                    window.open(track.filePath, '_blank');
                }
            }
            
            // Function to filter and search tracks
            function filterTracks() {
                const filteredTracks = tracks.filter(track => {
                    // Check if track matches the current filter
                    const extension = getFileExtension(track.filePath);
                    const matchesFilter = currentFilter === 'all' || 
                                         (currentFilter === 'mp3' && extension === 'mp3') ||
                                         (currentFilter === 'mp4' && extension === 'mp4') ||
                                         (currentFilter === 'jpg' && extension === 'jpg');
                    
                    // Check if track matches the search query
                    const matchesSearch = currentSearchQuery === '' || 
                                        track.title.toLowerCase().includes(currentSearchQuery) ||
                                        track.artist.toLowerCase().includes(currentSearchQuery);
                    
                    return matchesFilter && matchesSearch;
                });
                
                renderFilteredPlaylist(filteredTracks);
                updateResultsCount(filteredTracks.length);
            }
            
            // Function to render filtered playlist
            function renderFilteredPlaylist(filteredTracks) {
                if (filteredTracks.length === 0) {
                    playlistContainer.innerHTML = `
                        <div class="no-music-message">
                            <p>No tracks found matching your search.</p>
                        </div>
                    `;
                    return;
                }
                
                let playlistHTML = '';
                filteredTracks.forEach((track, index) => {
                    // Find the original index in the full tracks array
                    const originalIndex = tracks.findIndex(t => t.filePath === track.filePath);
                    
                    // Format title and artist
                    const displayTitle = track.title.replace(/_/g, ' ');
                    const displayArtist = track.artist.replace(/_/g, ' ');
                    
                    playlistHTML += `
                        <div class="track-card" data-index="${originalIndex}">
                            <div class="track-image">
                                <img src="${track.thumbPath}" alt="${displayTitle}">
                                <div class="play-overlay">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="track-info">
                                <div class="track-title">${displayTitle}</div>
                                <div class="track-artist">${displayArtist}</div>
                            </div>
                        </div>
                    `;
                });
                
                // Add a "Load More" button at the end if we're not filtering
                if (currentFilter === 'all' && currentSearchQuery === '') {
                    playlistHTML += `
                        <div class="load-more-container">
                            <button class="load-more" id="load-more">Load More Tracks</button>
                        </div>
                    `;
                }
                
                playlistContainer.innerHTML = playlistHTML;
                
                // Add click event to all track cards
                document.querySelectorAll('.track-card').forEach(card => {
                    card.addEventListener('click', function() {
                        handleTrackClick(parseInt(this.dataset.index));
                    });
                });
                
                // Add click event to load more button if it exists
                const loadMoreBtn = document.getElementById('load-more');
                if (loadMoreBtn) {
                    loadMoreBtn.addEventListener('click', function() {
                        loadNextJson();
                    });
                }
            }
            
            // Function to update results count
            function updateResultsCount(count) {
                resultsCount.textContent = `${count} ${count === 1 ? 'result' : 'results'} found`;
            }
            
            // Fetch music data from JSON file
            function loadMusicData(jsonFile) {
                isLoading = true;
                
                // Show loading indicator if it's not the first load
                if (jsonFile !== 'data_json/data.json') {
                    const loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'load-more-container';
                    loadMoreDiv.innerHTML = '<p>Loading more tracks...</p>';
                    playlistContainer.appendChild(loadMoreDiv);
                }
                
                fetch(jsonFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load ${jsonFile}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Remove loading indicator if it exists
                        const loadingIndicator = playlistContainer.querySelector('.load-more-container');
                        if (loadingIndicator) {
                            playlistContainer.removeChild(loadingIndicator);
                        }
                        
                        // If this is the first load, replace tracks
                        if (jsonFile === 'data_json/data.json') {
                            tracks = data;
                        } else {
                            // For subsequent loads, append to tracks
                            tracks = [...tracks, ...data];
                        }
                        
                        isLoading = false;
                        filterTracks();
                        
                        // If there are tracks, load the first one
                        if (tracks.length > 0 && jsonFile === 'data_json/data.json') {
                            loadTrack(0);
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading ${jsonFile}:`, error);
                        
                        // If this is the first load and it fails, show error
                        if (jsonFile === 'data_json/data.json') {
                            playlistContainer.innerHTML = `
                                <div class="no-music-message">
                                    <p>Failed to load music data. Please make sure musics.json exists and is properly formatted.</p>
                                    <p>Error: ${error.message}</p>
                                </div>
                            `;
                        }
                        
                        isLoading = false;
                    });
            }
            
            // Function to load the next JSON file
            function loadNextJson() {
                if (isLoading) return;
                
                currentJsonIndex++;
                const nextJsonFile = `data_${currentJsonIndex}.json`;
                loadMusicData(nextJsonFile);
            }
            
            // Function to load a track
            function loadTrack(index) {
                const track = tracks[index];
                if (!track) return;
                
                // Reset active class on all tracks
                document.querySelectorAll('.track-card').forEach(card => {
                    card.classList.remove('active');
                });
                
                // Add active class to current track
                const currentCard = document.querySelector(`.track-card[data-index="${index}"]`);
                if (currentCard) {
                    currentCard.classList.add('active');
                }
                
                // Format display title and artist (replace underscores with spaces)
                const displayTitle = track.title.replace(/_/g, ' ');
                const displayArtist = track.artist.replace(/_/g, ' ');
                
                // Update player info
                audioPlayer.src = track.filePath;
                currentThumbnail.src = track.thumbPath;
                currentTitle.textContent = displayTitle;
                currentArtist.textContent = displayArtist;
                
                // Reset progress
                progress.style.width = '0%';
                currentTime.textContent = '0:00';
                
                // Get duration after metadata is loaded
                audioPlayer.addEventListener('loadedmetadata', function() {
                    duration.textContent = formatTime(audioPlayer.duration);
                });
            }
            
            // Function to load a video track
            function loadVideoTrack(index) {
                const track = tracks[index];
                if (!track) return;
                
                // Format display title and artist (replace underscores with spaces)
                const displayTitle = track.title.replace(/_/g, ' ');
                const displayArtist = track.artist.replace(/_/g, ' ');
                
                // Update video player info
                videoPlayer.src = track.filePath;
                videoThumbnail.src = track.thumbPath;
                videoTitle.textContent = displayTitle;
                videoArtist.textContent = displayArtist;
                
                // Reset progress
                videoProgress.style.width = '0%';
                videoCurrentTime.textContent = '0:00';
                
                // Get duration after metadata is loaded
                videoPlayer.addEventListener('loadedmetadata', function() {
                    videoDuration.textContent = formatTime(videoPlayer.duration);
                });
            }
            
            // Function to play track
            function playTrack() {
                const playPromise = audioPlayer.play();
                
                // Handle play promise (required for modern browsers)
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        isPlaying = true;
                        playButton.innerHTML = '<i class="fas fa-pause"></i>';
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                    });
                }
            }
            
            // Function to play video track
            function playVideoTrack() {
                const playPromise = videoPlayer.play();
                
                // Handle play promise (required for modern browsers)
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        isVideoPlaying = true;
                        videoPlayButton.innerHTML = '<i class="fas fa-pause"></i>';
                    })
                    .catch(error => {
                        console.error('Error playing video:', error);
                    });
                }
            }
            
            // Function to pause track
            function pauseTrack() {
                audioPlayer.pause();
                isPlaying = false;
                playButton.innerHTML = '<i class="fas fa-play"></i>';
            }
            
            // Function to pause video track
            function pauseVideoTrack() {
                videoPlayer.pause();
                isVideoPlaying = false;
                videoPlayButton.innerHTML = '<i class="fas fa-play"></i>';
            }
            
            // Function to play next track
            function nextTrack() {
                // Find the next track that matches current filter/search
                let nextIndex = currentTrackIndex + 1;
                while (nextIndex < tracks.length) {
                    const track = tracks[nextIndex];
                    const extension = getFileExtension(track.filePath);
                    const matchesFilter = currentFilter === 'all' || 
                                         (currentFilter === 'mp3' && extension === 'mp3') ||
                                         (currentFilter === 'mp4' && extension === 'mp4') ||
                                         (currentFilter === 'jpg' && extension === 'jpg');
                    const matchesSearch = currentSearchQuery === '' || 
                                        track.title.toLowerCase().includes(currentSearchQuery) ||
                                        track.artist.toLowerCase().includes(currentSearchQuery);
                    
                    if (matchesFilter && matchesSearch) break;
                    nextIndex++;
                }
                
                if (nextIndex >= tracks.length) {
                    nextIndex = 0;
                    while (nextIndex < tracks.length) {
                        const track = tracks[nextIndex];
                        const extension = getFileExtension(track.filePath);
                        const matchesFilter = currentFilter === 'all' || 
                                             (currentFilter === 'mp3' && extension === 'mp3') ||
                                             (currentFilter === 'mp4' && extension === 'mp4') ||
                                             (currentFilter === 'jpg' && extension === 'jpg');
                        const matchesSearch = currentSearchQuery === '' || 
                                            track.title.toLowerCase().includes(currentSearchQuery) ||
                                            track.artist.toLowerCase().includes(currentSearchQuery);
                        
                        if (matchesFilter && matchesSearch) break;
                        nextIndex++;
                    }
                    
                    if (nextIndex >= tracks.length) return;
                }
                
                currentTrackIndex = nextIndex;
                loadTrack(currentTrackIndex);
                playTrack();
            }
            
            // Function to play next video track
            function nextVideoTrack() {
                // Find the next MP4 file
                let nextIndex = currentVideoIndex + 1;
                while (nextIndex < tracks.length && getFileExtension(tracks[nextIndex].filePath) !== 'mp4') {
                    nextIndex++;
                }
                
                if (nextIndex >= tracks.length) {
                    nextIndex = 0;
                    // Find the first MP4 file
                    while (nextIndex < tracks.length && getFileExtension(tracks[nextIndex].filePath) !== 'mp4') {
                        nextIndex++;
                    }
                    
                    if (nextIndex >= tracks.length) {
                        // No MP4 files found
                        closeVideoModal();
                        return;
                    }
                }
                
                currentVideoIndex = nextIndex;
                loadVideoTrack(currentVideoIndex);
                playVideoTrack();
            }
            
            // Function to play previous track
            function prevTrack() {
                // Find the previous track that matches current filter/search
                let prevIndex = currentTrackIndex - 1;
                while (prevIndex >= 0) {
                    const track = tracks[prevIndex];
                    const extension = getFileExtension(track.filePath);
                    const matchesFilter = currentFilter === 'all' || 
                                         (currentFilter === 'mp3' && extension === 'mp3') ||
                                         (currentFilter === 'mp4' && extension === 'mp4') ||
                                         (currentFilter === 'jpg' && extension === 'jpg');
                    const matchesSearch = currentSearchQuery === '' || 
                                        track.title.toLowerCase().includes(currentSearchQuery) ||
                                        track.artist.toLowerCase().includes(currentSearchQuery);
                    
                    if (matchesFilter && matchesSearch) break;
                    prevIndex--;
                }
                
                if (prevIndex < 0) {
                    prevIndex = tracks.length - 1;
                    while (prevIndex >= 0) {
                        const track = tracks[prevIndex];
                        const extension = getFileExtension(track.filePath);
                        const matchesFilter = currentFilter === 'all' || 
                                             (currentFilter === 'mp3' && extension === 'mp3') ||
                                             (currentFilter === 'mp4' && extension === 'mp4') ||
                                             (currentFilter === 'jpg' && extension === 'jpg');
                        const matchesSearch = currentSearchQuery === '' || 
                                            track.title.toLowerCase().includes(currentSearchQuery) ||
                                            track.artist.toLowerCase().includes(currentSearchQuery);
                        
                        if (matchesFilter && matchesSearch) break;
                        prevIndex--;
                    }
                    
                    if (prevIndex < 0) return;
                }
                
                currentTrackIndex = prevIndex;
                loadTrack(currentTrackIndex);
                playTrack();
            }
            
            // Function to play previous video track
            function prevVideoTrack() {
                // Find the previous MP4 file
                let prevIndex = currentVideoIndex - 1;
                while (prevIndex >= 0 && getFileExtension(tracks[prevIndex].filePath) !== 'mp4') {
                    prevIndex--;
                }
                
                if (prevIndex < 0) {
                    prevIndex = tracks.length - 1;
                    // Find the last MP4 file
                    while (prevIndex >= 0 && getFileExtension(tracks[prevIndex].filePath) !== 'mp4') {
                        prevIndex--;
                    }
                    
                    if (prevIndex < 0) {
                        // No MP4 files found
                        closeVideoModal();
                        return;
                    }
                }
                
                currentVideoIndex = prevIndex;
                loadVideoTrack(currentVideoIndex);
                playVideoTrack();
            }
            
            // Function to format time
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }
            
            // Function to close video modal
            function closeVideoModal() {
                pauseVideoTrack();
                videoModal.style.display = 'none';
            }
            
            // Event listeners for search and filter
            searchInput.addEventListener('input', function() {
                currentSearchQuery = this.value.toLowerCase();
                filterTracks();
            });
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterTracks();
                });
            });
            
            // Play/Pause button event
            playButton.addEventListener('click', function() {
                if (tracks.length === 0) return;
                
                if (!audioPlayer.src) {
                    loadTrack(0);
                }
                
                if (isPlaying) {
                    pauseTrack();
                } else {
                    playTrack();
                }
            });
            
            // Video Play/Pause button event
            videoPlayButton.addEventListener('click', function() {
                if (isVideoPlaying) {
                    pauseVideoTrack();
                } else {
                    playVideoTrack();
                }
            });
            
            // Next button event
            nextButton.addEventListener('click', function() {
                if (tracks.length === 0) return;
                nextTrack();
            });
            
            // Video Next button event
            videoNextButton.addEventListener('click', function() {
                nextVideoTrack();
            });
            
            // Previous button event
            prevButton.addEventListener('click', function() {
                if (tracks.length === 0) return;
                prevTrack();
            });
            
            // Video Previous button event
            videoPrevButton.addEventListener('click', function() {
                prevVideoTrack();
            });
            
            // Close video modal event
            closeVideo.addEventListener('click', function() {
                closeVideoModal();
            });
            
            // Close modal when clicking outside
            videoModal.addEventListener('click', function(e) {
                if (e.target === videoModal) {
                    closeVideoModal();
                }
            });
            
            // Progress bar update for audio
            audioPlayer.addEventListener('timeupdate', function() {
                const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progress.style.width = `${percentage}%`;
                currentTime.textContent = formatTime(audioPlayer.currentTime);
            });
            
            // Progress bar update for video
            videoPlayer.addEventListener('timeupdate', function() {
                const percentage = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                videoProgress.style.width = `${percentage}%`;
                videoCurrentTime.textContent = formatTime(videoPlayer.currentTime);
            });
            
            // Click on progress bar to seek (audio)
            progressBar.addEventListener('click', function(e) {
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const duration = audioPlayer.duration;
                
                audioPlayer.currentTime = (clickX / width) * duration;
            });
            
            // Click on progress bar to seek (video)
            videoProgressBar.addEventListener('click', function(e) {
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const duration = videoPlayer.duration;
                
                videoPlayer.currentTime = (clickX / width) * duration;
            });
            
            // Volume control (audio)
            volumeSlider.addEventListener('click', function(e) {
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const volume = clickX / width;
                
                audioPlayer.volume = volume;
                volumeLevel.style.width = `${volume * 100}%`;
            });
            
            // Volume control (video)
            videoVolumeSlider.addEventListener('click', function(e) {
                const width = this.clientWidth;
                const clickX = e.offsetX;
                const volume = clickX / width;
                
                videoPlayer.volume = volume;
                videoVolumeLevel.style.width = `${volume * 100}%`;
            });
            
            // When audio track ends, play next one
            audioPlayer.addEventListener('ended', function() {
                nextTrack();
            });
            
            // When video track ends, play next one
            videoPlayer.addEventListener('ended', function() {
                nextVideoTrack();
            });
            
            // Set initial volume
            audioPlayer.volume = 0.7;
            volumeLevel.style.width = '70%';
            videoPlayer.volume = 0.7;
            videoVolumeLevel.style.width = '70%';
            
            // Infinite scroll detection
            window.addEventListener('scroll', function() {
                if (currentFilter !== 'all' || currentSearchQuery !== '') return;
                
                const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                
                // Check if we're near the bottom of the page
                if (scrollTop + clientHeight >= scrollHeight - 100 && !isLoading) {
                    loadNextJson();
                }
            });
            
            // Initial load
            loadMusicData('data_json/data.json');
        });
    </script>
</body>
</html>